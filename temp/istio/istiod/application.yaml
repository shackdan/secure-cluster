apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: istio-istiod
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  project: default
  source:
    repoURL: https://istio-release.storage.googleapis.com/charts
    chart: istiod
    targetRevision: 1.26.2
    helm:
      values: |-
        pilot:
          env:
            EXTERNAL_ISTIOD: false
            # Enable CNI mode
            PILOT_ENABLE_CNI: true
        # CRITICAL: This tells istiod that CNI is available
        meshConfig:
          defaultConfig:
            # This is key - tells the proxy it's running with CNI
            proxyMetadata:
              ISTIO_META_CNI_ENABLED: "true"
        # Global CNI configuration
        global:
          # Tell the entire mesh CNI is enabled
          cni:
            enabled: true
          # Configure mesh for CNI mode
          meshConfig:
            defaultConfig:
              proxyMetadata:
                ISTIO_META_CNI_ENABLED: "true"
        # Sidecar injection configuration
        sidecarInjectorWebhook:
          # Don't rewrite probes when using CNI
          rewriteAppHTTPProbe: true
          # Enable CNI mode in injector
          enableNamespacesByDefault: false
          # Custom values for CNI injection
          values:
            global:
              cni:
                enabled: true
        # Proxy configuration for security
        proxy:
          runAsRoot: false
          runAsUser: 1001
          runAsGroup: 1001
  destination:
    server: https://kubernetes.default.svc
    namespace: istio-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
  ignoreDifferences:
  - group: admissionregistration.k8s.io
    kind: ValidatingAdmissionWebhook
    name: istiod-default-validator
    jsonPointers:
    - /webhooks/0/clientConfig/caBundle
    - /webhooks/0/failurePolicy
    - /webhooks/0/timeoutSeconds
    - /webhooks/0/admissionReviewVersions
    - /webhooks/0/sideEffects
  - group: admissionregistration.k8s.io
    kind: ValidatingWebhookConfiguration
    jsonPointers:
    - /webhooks